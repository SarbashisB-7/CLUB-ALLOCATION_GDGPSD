<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>GD Goenka â€” Club Allocation 2026-27</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0D1117;color:#E6EDF3;font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;min-height:100vh}
button{cursor:pointer;font-family:inherit;transition:opacity .15s}
button:hover{opacity:.82}
button:disabled{opacity:.4;cursor:not-allowed}
input,select,textarea{background:#0D1117;color:#E6EDF3;border:1px solid #30363D;border-radius:6px;padding:8px 11px;font-family:inherit;font-size:13px;width:100%;outline:none}
input:focus,select:focus,textarea:focus{border-color:#2F81F7}
table{width:100%;border-collapse:collapse}
th{background:#1C2128;color:#8B949E;padding:8px 12px;text-align:left;font-size:10px;letter-spacing:1px;border-bottom:1px solid #30363D;white-space:nowrap}
td{padding:8px 12px;border-bottom:1px solid #30363D20;font-size:12px;vertical-align:middle}
tr:hover td{background:#1C212860}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:#30363D;border-radius:3px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
.card{background:#161B22;border:1px solid #30363D;border-radius:8px;padding:18px 22px;margin-bottom:16px}
.lbl{font-size:11px;color:#8B949E;letter-spacing:.8px;margin-bottom:5px;display:block;font-weight:600}
.btn{color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;font-size:12px;white-space:nowrap}
.btnO{background:transparent;border:1px solid #30363D;border-radius:6px;padding:7px 14px;font-size:12px;color:#8B949E}
.tab{padding:6px 14px;border:none;border-radius:6px;font-size:12px}
.g2{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.g3{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.g4{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.ov{overflow-x:auto}
.chip{display:inline-block;border-radius:4px;padding:2px 7px;font-size:10px;white-space:nowrap}
</style>
</head>
<body>
<div id="root"></div>
<script type="module">
import { initializeApp }       from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch, getDocs }
                               from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = initializeApp({
  apiKey:            "AIzaSyAdRgwlrX6mOuUGBmlM00JQC-73HkmVXtM",
  authDomain:        "gd-goenka-clubs-5b00d.firebaseapp.com",
  projectId:         "gd-goenka-clubs-5b00d",
  storageBucket:     "gd-goenka-clubs-5b00d.firebasestorage.app",
  messagingSenderId: "293847865717",
  appId:             "1:293847865717:web:b5e0a0cdf535adc120db3c"
});
const db  = getFirestore(app);
const COL = collection(db, "students");

// â”€â”€ CLUB DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CLUBS = {
  A:[
    {id:"A1",name:"Art Club",cap:225},
    {id:"A2",name:"Eco Club",cap:225},
    {id:"A3",name:"Non-Fire Cooking Club",cap:120},
    {id:"A4",name:"Quiz & Heritage Club",cap:150},
    {id:"A5",name:"Dance Club",cap:85},
    {id:"A6",name:"Creative Expressions Club",cap:210,acts:[
      {id:"A6-French",name:"French",cap:40},
      {id:"A6-Drama",name:"Drama",cap:40},
      {id:"A6-Writing",name:"Creative Writing",cap:100},
      {id:"A6-Reading",name:"Reading",cap:30}
    ]},
    {id:"A7",name:"Music Club",cap:85},
    {id:"A8",name:"Karate Club",cap:100},
  ],
  B:[
    {id:"B1",name:"Tech Club",cap:50},
    {id:"B2",name:"Literary Expressions Club",cap:130,acts:[
      {id:"B2-Debate",name:"Debate",cap:50},
      {id:"B2-Writing",name:"Creative Writing",cap:50},
      {id:"B2-Reading",name:"Reading",cap:30}
    ]},
    {id:"B3",name:"Math Club",cap:40},
    {id:"B4",name:"Science Club",cap:60},
    {id:"B5",name:"Explorers Club",cap:120,acts:[
      {id:"B5-Eco",name:"Eco",cap:40},
      {id:"B5-Quiz",name:"Quiz",cap:35},
      {id:"B5-Heritage",name:"Heritage",cap:45}
    ]},
    {id:"B6",name:"Health & Fitness Club",cap:120,acts:[
      {id:"B6-Yoga",name:"Yoga",cap:30},
      {id:"B6-TT",name:"Table Tennis",cap:30},
      {id:"B6-Squash",name:"Squash",cap:20},
      {id:"B6-Cricket",name:"Cricket",cap:40}
    ]},
    {id:"B7",name:"Rhythm & Vibration Club",cap:120,acts:[
      {id:"B7-Western",name:"Western Dance",cap:30},
      {id:"B7-Eastern",name:"Eastern Dance",cap:30},
      {id:"B7-Instrumental",name:"Instrumental",cap:30},
      {id:"B7-Vocal",name:"Vocal Music",cap:30}
    ]},
    {id:"B8",name:"Artistic Expressions Club",cap:40},
  ],
  C:[
    {id:"C1",name:"AI & Data Science Club",cap:40},
    {id:"C2",name:"Science & Technology Club",cap:60},
    {id:"C3",name:"Non-Fire Cooking Club",cap:40},
    {id:"C4",name:"Commerce Club",cap:30},
    {id:"C5",name:"Literary, Quiz & Cultural Heritage Club",cap:115,acts:[
      {id:"C5-Literary",name:"Literary",cap:40},
      {id:"C5-Quiz",name:"Quiz",cap:30},
      {id:"C5-Heritage",name:"Cultural Heritage",cap:45}
    ]},
    {id:"C6",name:"Performing Arts Club",cap:160,acts:[
      {id:"C6-Western",name:"Western Dance",cap:30},
      {id:"C6-Eastern",name:"Eastern Dance",cap:30},
      {id:"C6-Music",name:"Music",cap:30},
      {id:"C6-Drama",name:"Drama",cap:40},
      {id:"C6-Yoga",name:"Yoga",cap:30}
    ]},
    {id:"C7",name:"Sports & Defence Club",cap:140,acts:[
      {id:"C7-Chess",name:"Chess",cap:40},
      {id:"C7-Football",name:"Football",cap:40},
      {id:"C7-Basketball",name:"Basketball",cap:30},
      {id:"C7-Taekwondo",name:"Taekwondo",cap:30}
    ]},
    {id:"C8",name:"Foreign Language & Global Skills Club",cap:130,acts:[
      {id:"C8-Spanish",name:"Spanish",cap:30},
      {id:"C8-Reading",name:"Reading",cap:30},
      {id:"C8-Writing",name:"Creative Writing",cap:40},
      {id:"C8-Debate",name:"Debate",cap:30}
    ]},
  ]
};
const ALL    = Object.values(CLUBS).flat();
const GRADES = ["Nursery/BV1","UKG/BV2","KG/BV3","I","II","III","IV","V","VI","VII","VIII","IX"];

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function seg(g){
  if(["Nursery/BV1","UKG/BV2","KG/BV3","I","II","III","IV","V"].includes(g)) return "A";
  if(["VI","VII"].includes(g)) return "B";
  if(["VIII","IX"].includes(g)) return "C";
  return null;
}
const gClub = id => ALL.find(c=>c.id===id);
const gAct  = (cid,aid) => gClub(cid)?.acts?.find(a=>a.id===aid);
const isAdmin = new URLSearchParams(location.search).get("admin")==="true";
const C = {bg:"#0D1117",card:"#161B22",bdr:"#30363D",hd:"#1C2128",acc:"#2F81F7",grn:"#3FB950",amb:"#D29922",red:"#F85149",pur:"#BC8CFF",teal:"#39C5CF",txt:"#E6EDF3",mut:"#8B949E"};
const rc  = p => p==="1st"?C.grn:p==="2nd"?C.acc:p==="3rd"?C.amb:p==="admin"?C.pur:C.red;
const chip = (t,c) => `<span class="chip" style="background:${c}22;color:${c};border:1px solid ${c}44">${t}</span>`;
const btn  = (t,fn,col,sm) => `<button class="btn${sm?" btn-sm":""}" style="background:${col}" onclick="${fn}">${t}</button>`;

function dlCSV(name,rows){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([rows.join("\n")],{type:"text/csv"}));
  a.download=name; a.click();
}
function parseCSV(txt){
  const lines=txt.trim().split("\n"),out=[];
  for(let i=1;i<lines.length;i++){
    const c=lines[i].split(",").map(x=>x.trim().replace(/^"|"$/g,""));
    if(!c[0]) continue;
    out.push({name:c[0],grade:c[1]||"",section:c[2]||"",p1:c[3]||"",a1:c[4]||"",p2:c[5]||"",a2:c[6]||"",p3:c[7]||"",a3:c[8]||"",by:c[9]||"CSV",at:new Date().toISOString()});
  }
  return out;
}

// â”€â”€ ALLOCATION ALGORITHM (unchanged) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function counts(list){
  const cc={},ac={};
  ALL.forEach(c=>{ cc[c.id]=0; c.acts?.forEach(a=>{ ac[a.id]=0; }); });
  list.forEach(s=>{
    if(s.aC) cc[s.aC]=(cc[s.aC]||0)+1;
    if(s.aA) ac[s.aA]=(ac[s.aA]||0)+1;
  });
  return {cc,ac};
}
function allocate(s,cc,ac){
  const sg=seg(s.grade);
  if(!sg) return {aC:null,aA:null,pU:null,rsn:"Invalid grade"};
  for(const [pc,pa,lbl] of [[s.p1,s.a1,"1st"],[s.p2,s.a2,"2nd"],[s.p3,s.a3,"3rd"]]){
    if(!pc) continue;
    const club=CLUBS[sg].find(c=>c.id===pc);
    if(!club) continue;
    if(club.acts){
      if(!pa) continue;
      const act=club.acts.find(a=>a.id===pa);
      if(act&&(ac[act.id]||0)<act.cap) return {aC:club.id,aA:act.id,pU:lbl,rsn:lbl+" preference"};
    } else {
      if((cc[club.id]||0)<club.cap) return {aC:club.id,aA:null,pU:lbl,rsn:lbl+" preference"};
    }
  }
  const avail=CLUBS[sg].flatMap(club=>{
    if(club.acts) return club.acts.filter(a=>(ac[a.id]||0)<a.cap).map(a=>({club,act:a,sp:a.cap-(ac[a.id]||0)}));
    return (cc[club.id]||0)<club.cap?[{club,act:null,sp:club.cap-(cc[club.id]||0)}]:[];
  }).sort((a,b)=>b.sp-a.sp);
  if(avail.length) return {aC:avail[0].club.id,aA:avail[0].act?.id||null,pU:"admin",rsn:"Administrative allocation"};
  return {aC:null,aA:null,pU:null,rsn:"No capacity â€” manual review"};
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let students=[], tab="entry", toasts=[];

// Teacher identity â€” persists for the full session
// name, grade & section stay locked until teacher manually changes them
let teacher = { by:"", grade:"", sec:"" };

// Per-student entry form â€” only student name + preferences reset after each entry
let form = { name:"", p1:"", a1:"", p2:"", a2:"", p3:"", a3:"" };

let csvTxt="", csvErr="";
let fSeg="ALL", fSt="ALL", fQ="", fGr="ALL";

// â”€â”€ FIRESTORE LISTENER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onSnapshot(query(COL,orderBy("at","asc")), snap=>{
  students=snap.docs.map(d=>({...d.data(),_id:d.id}));
  render();
}, e=>toast("DB error: "+e.message,C.red));

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg,col=C.grn,sub=""){
  const id=Date.now()+Math.random();
  toasts.push({id,msg,col,sub});
  render();
  setTimeout(()=>{ toasts=toasts.filter(t=>t.id!==id); render(); },5000);
}

// â”€â”€ DUPLICATE CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Blocks ONLY if same teacher + same name + same grade
function isDuplicate(name, grade){
  return students.some(s =>
    s.by === teacher.by &&
    s.name.trim().toLowerCase() === name.trim().toLowerCase() &&
    s.grade === grade
  );
}

// â”€â”€ ADD STUDENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addStudent(){
  if(!teacher.by||!form.name||!teacher.grade||!form.p1) return;
  const club=gClub(form.p1);
  if(club?.acts&&!form.a1){ toast("Please select an activity for 1st preference",C.amb); return; }

  // Duplicate guard
  if(isDuplicate(form.name, teacher.grade)){
    toast(
      `âš  You have already entered "${form.name}" from Grade ${teacher.grade}!`,
      C.red,
      "You cannot enter the same student twice. If this is a different student with the same name, ask another teacher to enter them."
    );
    return;
  }

  const {cc,ac}=counts(students);
  const al=allocate({...form, grade:teacher.grade, section:teacher.sec}, cc, ac);
  const s={
    name:form.name, grade:teacher.grade, section:teacher.sec||"",
    p1:form.p1||"", a1:form.a1||"",
    p2:form.p2||"", a2:form.a2||"",
    p3:form.p3||"", a3:form.a3||"",
    by:teacher.by, at:new Date().toISOString(), ...al
  };
  try{
    await addDoc(COL,s);
    const cl=gClub(s.aC), ac2=s.aA?gAct(s.aC,s.aA):null;
    if(cl){
      const lbl=s.pU==="admin"?"Administratively allocated":
        s.pU==="1st"?"âœ“ 1st preference honored":
        s.pU==="2nd"?"â†“ 2nd preference used (1st was full)":
        "â†“ 3rd preference used (1st & 2nd were full)";
      toast(`${s.name} â†’ ${cl.name}${ac2?" Â· "+ac2.name:""}`,rc(s.pU),lbl);
    } else {
      toast(`${s.name} â€” no seats available, manual review needed`,C.red);
    }
    // Reset ONLY student-specific fields; teacher identity stays
    form={name:"",p1:"",a1:"",p2:"",a2:"",p3:"",a3:""};
    render();
  } catch(e){ toast("Save failed: "+e.message,C.red); }
}

// â”€â”€ ADMIN ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function delStudent(fid){
  if(!isAdmin) return;
  try{ await deleteDoc(doc(db,"students",fid)); toast("Entry removed",C.amb); }
  catch(e){ toast("Delete failed: "+e.message,C.red); }
}
async function clearAll(){
  if(!isAdmin||!confirm("Delete ALL student data? Cannot be undone.")) return;
  const snap=await getDocs(COL);
  const b=writeBatch(db);
  snap.docs.forEach(d=>b.delete(d.ref));
  await b.commit(); toast("All data cleared",C.amb);
}
async function importCSV(){
  csvErr="";
  const rows=parseCSV(csvTxt);
  if(!rows.length){ csvErr="No valid rows found."; render(); return; }
  let running=[...students];
  const b=writeBatch(db);
  for(const r of rows){
    const {cc,ac}=counts(running);
    const al=allocate(r,cc,ac);
    const s={...r,...al};
    running.push(s);
    const ref=doc(COL);
    b.set(ref,s);
  }
  try{ await b.commit(); csvTxt=""; toast(`âœ“ ${rows.length} students imported`); }
  catch(e){ toast("Import failed: "+e.message,C.red); }
  render();
}

// â”€â”€ EXPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportMaster(){
  const hdr=`"#","Name","Grade","Section","Pref1","Act1","Pref2","Act2","Pref3","Act3","Allocated Club","Activity","Pref Used","Status","Teacher","Time"`;
  const rows=students.map((r,i)=>{
    const cl=gClub(r.aC),ac=r.aA?gAct(r.aC,r.aA):null;
    return [i+1,r.name,r.grade,r.section||"",r.p1||"",r.a1||"",r.p2||"",r.a2||"",r.p3||"",r.a3||"",
      cl?cl.name:"UNALLOCATED",ac?ac.name:"",r.pU||"",r.rsn||"",r.by||"",
      r.at?new Date(r.at).toLocaleString():""].map(v=>`"${v}"`).join(",");
  });
  dlCSV("GDGoenka_Master_2026-27.csv",[hdr,...rows]);
  toast("âœ“ Master list exported");
}
function exportClubWise(){
  const {cc,ac}=counts(students);
  const rows=[`"GD GOENKA DAKSHINESWAR â€” CLUB-WISE 2026-27"`,`"${new Date().toLocaleString()}"`,`""`];
  ["A","B","C"].forEach(sg=>{
    CLUBS[sg].forEach(cl=>{
      const mem=students.filter(r=>r.aC===cl.id);
      rows.push(`""`,`"SEGMENT ${sg} â€” ${cl.id}: ${cl.name} (${mem.length}/${cl.cap})"`);
      cl.acts?.forEach(a=>rows.push(`"  ${a.name}: ${ac[a.id]||0}/${a.cap}"`));
      rows.push(`"#","Name","Grade","Section","Activity","Pref Used","Teacher"`);
      mem.forEach((r,i)=>{ const a=r.aA?gAct(r.aC,r.aA):null; rows.push([i+1,r.name,r.grade,r.section||"",a?a.name:"",r.pU||"",r.by||""].map(v=>`"${v}"`).join(",")); });
      if(!mem.length) rows.push(`"(none)"`);
    });
  });
  dlCSV("GDGoenka_ClubWise_2026-27.csv",rows);
  toast("âœ“ Club-wise exported");
}
function exportGradeWise(){
  const rows=[`"GD GOENKA DAKSHINESWAR â€” GRADE-WISE 2026-27"`,`"${new Date().toLocaleString()}"`,`""`];
  GRADES.forEach(gr=>{
    const mem=students.filter(r=>r.grade===gr);
    if(!mem.length) return;
    rows.push(`""`,`"GRADE: ${gr} (${mem.length} students)"`);
    rows.push(`"#","Name","Section","Allocated Club","Activity","Pref Used","Teacher"`);
    mem.forEach((r,i)=>{ const cl=gClub(r.aC),a=r.aA?gAct(r.aC,r.aA):null; rows.push([i+1,r.name,r.section||"",cl?cl.name:"UNALLOCATED",a?a.name:"",r.pU||"",r.by||""].map(v=>`"${v}"`).join(",")); });
  });
  dlCSV("GDGoenka_GradeWise_2026-27.csv",rows);
  toast("âœ“ Grade-wise exported");
}
function exportClubGradeWise(){
  const rows=[`"GD GOENKA DAKSHINESWAR â€” CLUB + GRADE WISE 2026-27"`,`"${new Date().toLocaleString()}"`,`""`];
  ["A","B","C"].forEach(sg=>{
    CLUBS[sg].forEach(cl=>{
      const clubMem=students.filter(r=>r.aC===cl.id);
      if(!clubMem.length) return;
      rows.push(`""`,`"SEGMENT ${sg} â€” ${cl.id}: ${cl.name} (${clubMem.length} students)"`);
      const gradesInClub=[...new Set(clubMem.map(r=>r.grade))].sort((a,b)=>GRADES.indexOf(a)-GRADES.indexOf(b));
      gradesInClub.forEach(gr=>{
        const mem=clubMem.filter(r=>r.grade===gr);
        rows.push(`""`,`"  Grade: ${gr} (${mem.length} students)"`);
        rows.push(`"#","Name","Section","Activity","Pref Used","Teacher"`);
        mem.forEach((r,i)=>{ const a=r.aA?gAct(r.aC,r.aA):null; rows.push([i+1,r.name,r.section||"",a?a.name:"",r.pU||"",r.by||""].map(v=>`"${v}"`).join(",")); });
      });
    });
  });
  dlCSV("GDGoenka_ClubGradeWise_2026-27.csv",rows);
  toast("âœ“ Club + Grade-wise exported");
}
function exportUnalloc(){
  const bad=students.filter(r=>!r.aC);
  if(!bad.length){ toast("No unallocated students â€” great!"); return; }
  const hdr=`"Name","Grade","Section","Pref1","Pref2","Pref3","Reason","Teacher"`;
  dlCSV("GDGoenka_ManualReview.csv",[hdr,...bad.map(r=>[r.name,r.grade,r.section||"",r.p1||"",r.p2||"",r.p3||"",r.rsn||"",r.by||""].map(v=>`"${v}"`).join(","))]);
  toast("âœ“ Manual review list exported");
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){ document.getElementById("root").innerHTML=buildUI(); }

function capBar(n,cap,lbl,sm){
  const p=Math.min(100,Math.round(n/cap*100));
  const col=p>=100?C.red:p>=75?C.amb:C.grn;
  return `<div style="margin-bottom:${sm?6:0}px">
    ${lbl?`<div style="display:flex;justify-content:space-between;margin-bottom:3px">
      <span style="font-size:${sm?10:11}px;color:${C.mut}">${lbl}</span>
      <span style="font-size:${sm?10:11}px;font-weight:700;color:${col}">${n}/${cap}</span>
    </div>`:""}
    <div style="background:${C.bdr};border-radius:3px;height:${sm?4:6}px">
      <div style="width:${p}%;height:100%;background:${col};border-radius:3px"></div>
    </div>
    ${!sm?`<div style="font-size:9px;color:${col};margin-top:3px;font-weight:700">${p>=100?"FULL":p>=75?`FILLING Â· ${cap-n} left`:`${cap-n} seats left`}</div>`:""}
  </div>`;
}

function buildUI(){
  const {cc,ac}=counts(students);
  const sg=seg(teacher.grade), sgClubs=sg?CLUBS[sg]:[];
  const c1=gClub(form.p1), c2=gClub(form.p2), c3=gClub(form.p3);
  const total=students.length;
  const g1=students.filter(r=>r.pU==="1st").length;
  const g2=students.filter(r=>r.pU==="2nd").length;
  const g3=students.filter(r=>r.pU==="3rd").length;
  const ga=students.filter(r=>r.pU==="admin").length;
  const gf=students.filter(r=>!r.aC).length;

  // Admin sees all entries; teachers see only their own
  const myEntries=isAdmin
    ? [...students].reverse()
    : teacher.by
      ? [...students].filter(s=>s.by===teacher.by).reverse()
      : [];

  const cFull=id=>{ const cl=gClub(id); if(!cl) return false; return cl.acts?cl.acts.every(a=>(ac[a.id]||0)>=a.cap):(cc[id]||0)>=cl.cap; };
  const aFull=id=>{ const a=ALL.flatMap(c=>c.acts||[]).find(a=>a.id===id); return a?(ac[id]||0)>=a.cap:false; };
  const sLeft=(cid,aid)=>{ if(aid){const a=ALL.flatMap(c=>c.acts||[]).find(a=>a.id===aid);return a?a.cap-(ac[aid]||0):0;} const cl=gClub(cid);return cl?cl.cap-(cc[cid]||0):0; };

  const warns=[];
  if(form.p1){ if(c1?.acts&&form.a1&&aFull(form.a1)) warns.push(`1st choice activity "${gAct(form.p1,form.a1)?.name}" is FULL`); else if(!c1?.acts&&cFull(form.p1)) warns.push(`1st choice "${c1?.name}" is FULL`); }
  if(form.p2){ if(c2?.acts&&form.a2&&aFull(form.a2)) warns.push(`2nd choice activity "${gAct(form.p2,form.a2)?.name}" is FULL`); else if(!c2?.acts&&cFull(form.p2)) warns.push(`2nd choice "${c2?.name}" is FULL`); }
  if(form.p3){ if(c3?.acts&&form.a3&&aFull(form.a3)) warns.push(`3rd choice activity "${gAct(form.p3,form.a3)?.name}" is FULL`); else if(!c3?.acts&&cFull(form.p3)) warns.push(`3rd choice "${c3?.name}" is FULL`); }

  const TABS=isAdmin
    ?[["entry","ğŸ“ Entry"],["bulk","ğŸ“¤ Bulk"],["results","ğŸ“Š Results"],["exports","ğŸ“ Export"],["capacity","ğŸ« Capacity"],["guide","ğŸ“– Guide"]]
    :[["entry","ğŸ“ Entry"],["capacity","ğŸ« Live Capacity"],["guide","ğŸ“– Guide"]];

  // TOASTS
  const toastHTML=`<div style="position:fixed;top:14px;right:14px;z-index:999;display:flex;flex-direction:column;gap:8px;align-items:flex-end">
    ${toasts.map(t=>`<div style="background:${t.col};color:#fff;border-radius:8px;padding:10px 16px;font-size:12px;font-weight:600;animation:slideIn .25s ease;box-shadow:0 4px 20px ${t.col}55;max-width:340px">
      <div>${t.msg}</div>${t.sub?`<div style="font-size:10px;opacity:.85;margin-top:3px">${t.sub}</div>`:""}
    </div>`).join("")}
  </div>`;

  // HEADER
  const hdr=`<div style="background:${C.hd};border-bottom:1px solid ${C.bdr};padding:14px 22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;position:sticky;top:0;z-index:100">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:34px;height:34px;background:linear-gradient(135deg,${C.acc},${C.pur});border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:#fff">GD</div>
      <div>
        <div style="font-weight:700;font-size:15px">GD Goenka Â· Club Allocation 2026-27${isAdmin?` <span style="font-size:11px;color:${C.amb}">[ADMIN]</span>`:""}</div>
        <div style="font-size:11px;color:${C.mut}">${total} students enrolled Â· live Firebase sync</div>
      </div>
    </div>
    <div style="display:flex;gap:3px;flex-wrap:wrap">
      ${TABS.map(([t,l])=>`<button class="tab" onclick="ST('${t}')" style="background:${tab===t?C.acc:"transparent"};color:${tab===t?"#fff":C.mut};font-weight:${tab===t?700:400}">${l}</button>`).join("")}
    </div>
  </div>`;

  // â”€â”€ TEACHER IDENTITY PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Shown at top of entry â€” teacher fills this once, stays for full session
  const identityPanel=`<div class="card" style="border-left:3px solid ${C.acc};padding:14px 18px;margin-bottom:12px">
    <div style="font-weight:700;font-size:13px;margin-bottom:10px;color:${C.acc}">ğŸ‘¤ Your Identity â€” set once, stays for your full session</div>
    <div class="g2">
      <div>
        <label class="lbl">YOUR NAME *</label>
        <input value="${teacher.by}" oninput="ST_by(this.value)" onblur="ST_byR(this.value)" placeholder="Ms. Banerjee" style="border-color:${!teacher.by?C.amb:C.bdr}"/>
        ${!teacher.by?`<div style="font-size:10px;color:${C.amb};margin-top:3px">Required before adding students</div>`:""}
      </div>
      <div>
        <label class="lbl">GRADE YOU ARE ENTERING *</label>
        <select onchange="ST_grade(this.value)" style="border-color:${!teacher.grade?C.amb:C.bdr}">
          <option value="">â€” Select Grade â€”</option>
          ${GRADES.map(g=>`<option value="${g}"${teacher.grade===g?" selected":""}>${g}</option>`).join("")}
        </select>
        ${!teacher.grade?`<div style="font-size:10px;color:${C.amb};margin-top:3px">Required before adding students</div>`:""}
      </div>
      <div>
        <label class="lbl">SECTION</label>
        <input value="${teacher.sec}" oninput="ST_sec(this.value)" onblur="ST_secR(this.value)" placeholder="A / B / C" maxlength="2"/>
      </div>
    </div>
    ${teacher.by&&teacher.grade?`<div style="margin-top:10px;font-size:11px;color:${C.grn}">âœ“ Entering students for <b>Grade ${teacher.grade}${teacher.sec?" Â· Section "+teacher.sec:""}</b> as <b>${teacher.by}</b></div>`:""}
  </div>`;

  // â”€â”€ PREFERENCE ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function prefRow(pfk,pak,lbl,club){
    const sv=form[pfk],av=form[pak];
    const f1=sv&&!club?.acts&&cFull(sv);
    const f2=av&&aFull(av);
    return `<div style="margin-bottom:12px">
      <div style="display:grid;grid-template-columns:${club?.acts?"2fr 1fr":"1fr"};gap:12px">
        <div>
          <label class="lbl">${lbl}</label>
          <select onchange="SP('${pfk}','${pak}',this.value)" style="border-color:${f1?C.red:C.bdr}" ${!sg?"disabled":""}>
            <option value="">â€” Select Club â€”</option>
            ${sgClubs.map(c=>{ const fl=cFull(c.id),sl=sLeft(c.id); return `<option value="${c.id}"${form[pfk]===c.id?" selected":""}>${c.id}: ${c.name}${c.acts?" [+ Activity]":""} Â· ${fl?"FULL":sl+" left"}</option>`; }).join("")}
          </select>
          ${f1?`<div style="font-size:10px;color:${C.red};margin-top:3px">ğŸ”´ Full â€” next preference will be tried automatically</div>`:""}
        </div>
        ${club?.acts?`<div>
          <label class="lbl">ACTIVITY</label>
          <select onchange="SF('${pak}',this.value)" style="border-color:${f2?C.red:C.bdr}">
            <option value="">â€” Select â€”</option>
            ${club.acts.map(a=>{ const fl=aFull(a.id),sl=sLeft(null,a.id); return `<option value="${a.id}"${form[pak]===a.id?" selected":""}>${a.name} Â· ${fl?"FULL":sl+" left"}</option>`; }).join("")}
          </select>
          ${f2?`<div style="font-size:10px;color:${C.red};margin-top:3px">ğŸ”´ Full</div>`:""}
        </div>`:""}
      </div>
    </div>`;
  }

  // â”€â”€ ENTRY TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const entryTab=`
  ${identityPanel}
  <div class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <div>
        <div style="font-weight:700;font-size:15px;margin-bottom:3px">Student Entry</div>
        <div style="font-size:12px;color:${C.mut}">Allocation happens <b style="color:${C.txt}">instantly</b> Â· enter all 3 preferences even if clubs appear full</div>
      </div>
      ${isAdmin&&total>0?`<button class="btnO" onclick="CA()" style="color:${C.red}">ğŸ—‘ Clear All</button>`:""}
    </div>
    <div style="margin-bottom:14px">
      <label class="lbl">STUDENT NAME *</label>
      <input value="${form.name}" oninput="SF('name',this.value)" onblur="SFR('name',this.value)" placeholder="Full name" onkeydown="if(event.key==='Enter')AS()" ${!teacher.by||!teacher.grade?"disabled":""}/>
    </div>
    ${warns.length?`<div style="background:${C.amb}15;border:1px solid ${C.amb}44;border-radius:6px;padding:10px 14px;margin-bottom:14px">
      <div style="font-size:11px;font-weight:700;color:${C.amb};margin-bottom:5px">âš  CAPACITY WARNINGS â€” full options will be skipped automatically</div>
      ${warns.map(w=>`<div style="font-size:11px;color:${C.amb};margin-bottom:2px">â€¢ ${w}</div>`).join("")}
    </div>`:""}
    ${prefRow("p1","a1","1ST PREFERENCE *",c1)}
    ${prefRow("p2","a2","2ND PREFERENCE",c2)}
    ${prefRow("p3","a3","3RD PREFERENCE",c3)}
    <div style="margin-top:14px;display:flex;gap:10px;justify-content:flex-end;align-items:center">
      ${!teacher.by||!teacher.grade?`<span style="font-size:11px;color:${C.amb}">âš  Complete your identity above first</span>`:""}
      <button class="btn" onclick="AS()" style="background:${C.acc}" ${!form.name||!teacher.grade||!form.p1||!teacher.by?"disabled":""}>+ Add & Allocate</button>
    </div>
  </div>

  ${teacher.by?`<div class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;align-items:center">
      <div style="font-weight:700;font-size:14px">${isAdmin?"All Entries":"Your Entries"}
        <span style="color:${C.mut};font-weight:400;font-size:12px"> Â· ${myEntries.length} student${myEntries.length!==1?"s":""} ${isAdmin?"enrolled total":"entered by you"}</span>
      </div>
      <div style="font-size:11px;color:${C.mut}">${isAdmin?"Showing all entries from all teachers Â· admin view":"Only your entries are shown here Â· capacity counts reflect all teachers"}</div>
    </div>
    ${myEntries.length===0
      ?`<div style="text-align:center;padding:28px;color:${C.mut};font-size:12px">No entries yet â€” add your first student above</div>`
      :`<div class="ov"><table>
        <thead><tr>${["#","Name","Grade","Sec","P1","P2","P3","âœ¦ Allocated Club","âœ¦ Activity","âœ¦ Status","Time",...(isAdmin?[""]:[])].map(h=>`<th>${h}</th>`).join("")}</tr></thead>
        <tbody>
          ${myEntries.map((s,i)=>{
            const cl=gClub(s.aC),ac2=s.aA?gAct(s.aC,s.aA):null;
            return `<tr style="${!s.aC?"background:"+C.red+"0d":""}">
              <td style="color:${C.mut}">${myEntries.length-i}</td>
              <td style="font-weight:600">${s.name}</td>
              <td>${chip(s.grade,C.acc)}</td>
              <td>${s.section||"â€”"}</td>
              <td>${chip(s.p1||"â€”",C.grn)}</td>
              <td>${chip(s.p2||"â€”",C.amb)}</td>
              <td>${chip(s.p3||"â€”",C.pur)}</td>
              <td style="font-weight:600;color:${cl?C.txt:C.red}">${cl?cl.id+": "+cl.name:"UNALLOCATED"}</td>
              <td style="color:${C.mut}">${ac2?ac2.name:"â€”"}</td>
              <td>${chip(s.pU==="admin"?"Admin":s.pU?s.pU+" pref":s.rsn||"â€”",rc(s.pU||""))}</td>
              <td style="color:${C.mut};font-size:10px">${s.at?new Date(s.at).toLocaleTimeString():"â€”"}</td>
              ${isAdmin?`<td><button onclick="DS('${s._id}')" style="background:none;border:none;color:${C.red};font-size:15px;line-height:1">âœ•</button></td>`:""}
            </tr>`;
          }).join("")}
        </tbody>
      </table></div>`
    }
  </div>`:""}`;

  // â”€â”€ BULK TAB (admin only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const bulkTab=`<div class="card">
    <div style="font-weight:700;font-size:15px;margin-bottom:4px">Bulk CSV Import</div>
    <div style="font-size:12px;color:${C.mut};margin-bottom:14px">Each student allocated instantly using live seat counts at time of import</div>
    <button class="btn" onclick="DLT()" style="background:${C.acc};margin-bottom:14px">â†“ Download Template</button>
    <div style="background:${C.bg};border:1px solid ${C.bdr};border-radius:6px;padding:12px;margin-bottom:12px;font-size:11px;color:${C.mut};line-height:2">
      <b style="color:${C.grn}">FORMAT:</b> Name, Grade, Section, Pref1, Pref1Activity, Pref2, Pref2Activity, Pref3, Pref3Activity, Teacher<br>
      <b style="color:${C.amb}">GRADES:</b> Nursery/BV1 Â· UKG/BV2 Â· KG/BV3 Â· Iâ€“V (Seg A) Â· VIâ€“VII (Seg B) Â· VIIIâ€“IX (Seg C)
    </div>
    <label class="lbl">PASTE CSV DATA</label>
    <textarea style="height:180px;resize:vertical" oninput="csvTxt=this.value" placeholder="Name,Grade,Section,Pref1,...">${csvTxt}</textarea>
    ${csvErr?`<div style="color:${C.red};font-size:11px;margin-top:5px">âš  ${csvErr}</div>`:""}
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btnO" onclick="csvTxt='';render()">Clear</button>
      <button class="btn" onclick="IC()" style="background:${C.acc}" ${!csvTxt.trim()?"disabled":""}>Import & Allocate All</button>
    </div>
  </div>`;

  // â”€â”€ RESULTS TAB (admin only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const usedGr=[...new Set(students.map(r=>r.grade))].sort((a,b)=>GRADES.indexOf(a)-GRADES.indexOf(b));
  const filt=students.filter(r=>{
    const s2=seg(r.grade);
    if(fSeg!=="ALL"&&s2!==fSeg) return false;
    if(fGr!=="ALL"&&r.grade!==fGr) return false;
    if(fSt==="1ST"&&r.pU!=="1st") return false;
    if(fSt==="2ND"&&r.pU!=="2nd") return false;
    if(fSt==="3RD"&&r.pU!=="3rd") return false;
    if(fSt==="ADM"&&r.pU!=="admin") return false;
    if(fSt==="FAIL"&&r.aC) return false;
    const q=fQ.toLowerCase();
    return !q||r.name.toLowerCase().includes(q)||r.grade.toLowerCase().includes(q);
  });
  const resultsTab=total===0
    ?`<div class="card" style="text-align:center;padding:60px"><div style="font-size:40px;margin-bottom:10px">ğŸ“Š</div><div style="color:${C.mut}">No students yet</div></div>`
    :`<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
      ${[["TOTAL",total,C.txt],["1ST",g1,C.grn],["2ND",g2,C.acc],["3RD",g3,C.amb],["ADMIN",ga,C.pur],["UNALLOC",gf,C.red]].map(([l,v,c])=>`
        <div style="background:${C.card};border:1px solid ${C.bdr};border-radius:8px;padding:12px 18px;flex:1;min-width:80px">
          <div style="font-size:26px;font-weight:800;color:${c}">${v}</div>
          <div style="font-size:9px;color:${C.mut};letter-spacing:1px">${l}</div>
          ${total>0?`<div style="font-size:10px;color:${c};margin-top:2px">${Math.round(v/total*100)}%</div>`:""}
        </div>`).join("")}
    </div>
    ${gf>0?`<div style="background:${C.red}11;border:1px solid ${C.red}33;border-radius:8px;padding:10px 16px;margin-bottom:12px;font-size:12px;color:${C.red}">âš  <b>${gf}</b> student${gf>1?"s":""} unallocated â€” export Manual Review list</div>`:""}
    <div class="card" style="padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
      <input style="width:180px" placeholder="Search name / gradeâ€¦" value="${fQ}" oninput="fQ=this.value;render()"/>
      <select style="width:140px" onchange="fSeg=this.value;fGr='ALL';render()">
        <option value="ALL">All Segments</option>
        ${["A","B","C"].map(s=>`<option value="${s}"${fSeg===s?" selected":""}>Segment ${s}</option>`).join("")}
      </select>
      <select style="width:120px" onchange="fGr=this.value;render()">
        <option value="ALL">All Grades</option>
        ${usedGr.map(g=>`<option value="${g}"${fGr===g?" selected":""}>${g}</option>`).join("")}
      </select>
      <select style="width:160px" onchange="fSt=this.value;render()">
        <option value="ALL"${fSt==="ALL"?" selected":""}>All Statuses</option>
        <option value="1ST"${fSt==="1ST"?" selected":""}>1st Preference</option>
        <option value="2ND"${fSt==="2ND"?" selected":""}>2nd Preference</option>
        <option value="3RD"${fSt==="3RD"?" selected":""}>3rd Preference</option>
        <option value="ADM"${fSt==="ADM"?" selected":""}>Admin Allocated</option>
        <option value="FAIL"${fSt==="FAIL"?" selected":""}>Unallocated</option>
      </select>
      <div style="margin-left:auto;display:flex;gap:8px">
        ${btn("â†“ Export All","EM()",C.grn)}
        ${btn("â†“ Unalloc","EU()",C.red,true)}
      </div>
    </div>
    <div class="card">
      <div style="font-size:12px;color:${C.mut};margin-bottom:10px">Showing ${filt.length} of ${total}</div>
      <div class="ov"><table>
        <thead><tr>${["Name","Grade","Sec","P1","P2","P3","âœ¦ Allocated Club","âœ¦ Activity","âœ¦ Status","Teacher",...(isAdmin?[""]:[])].map(h=>`<th>${h}</th>`).join("")}</tr></thead>
        <tbody>
          ${!filt.length?`<tr><td colspan="11" style="text-align:center;color:${C.mut};padding:28px">No records match</td></tr>`:""}
          ${filt.map(r=>{
            const cl=gClub(r.aC),ac2=r.aA?gAct(r.aC,r.aA):null;
            return `<tr style="${!r.aC?"background:"+C.red+"0d":""}">
              <td style="font-weight:600">${r.name}</td>
              <td>${chip(r.grade,C.acc)}</td>
              <td>${r.section||"â€”"}</td>
              <td>${chip(r.p1||"â€”",C.grn)}</td>
              <td>${chip(r.p2||"â€”",C.amb)}</td>
              <td>${chip(r.p3||"â€”",C.pur)}</td>
              <td style="font-weight:600;color:${cl?C.txt:C.red}">${cl?cl.id+": "+cl.name:"UNALLOCATED"}</td>
              <td style="color:${C.mut}">${ac2?ac2.name:"â€”"}</td>
              <td>${chip(r.pU==="admin"?"Admin":r.pU?r.pU+" pref":r.rsn||"â€”",rc(r.pU||""))}</td>
              <td style="color:${C.mut};font-size:11px">${r.by||"â€”"}</td>
              ${isAdmin?`<td><button onclick="DS('${r._id}')" style="background:none;border:none;color:${C.red};font-size:15px;line-height:1">âœ•</button></td>`:""}
            </tr>`;
          }).join("")}
        </tbody>
      </table></div>
    </div>`;

  // â”€â”€ EXPORTS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const exportsTab=`<div class="g3">
    ${[
      {icon:"ğŸ“‹",title:"Master List",desc:"Every student Â· one row each Â· full allocation details",col:C.acc,fn:"EM()"},
      {icon:"ğŸ«",title:"Club-wise Lists",desc:"Grouped by club â†’ full roster per club",col:C.grn,fn:"EC()"},
      {icon:"ğŸ“",title:"Grade-wise Lists",desc:"Grouped by grade â†’ which club each student got",col:C.pur,fn:"EG()"},
      {icon:"ğŸ«ğŸ“",title:"Club + Grade-wise",desc:"Each club broken down further by grade",col:C.teal,fn:"ECG()"},
      {icon:"âš ï¸",title:"Manual Review",desc:"Only unallocated students Â· all 3 preferences were full",col:C.red,fn:"EU()"},
    ].map(e=>`<div class="card" style="margin-bottom:0;border-left:3px solid ${e.col}">
      <div style="font-size:24px;margin-bottom:8px">${e.icon}</div>
      <div style="font-weight:700;font-size:13px;margin-bottom:4px">${e.title}</div>
      <div style="font-size:12px;color:${C.mut};margin-bottom:14px">${e.desc}</div>
      ${btn("â†“ Download CSV",e.fn,e.col)}
    </div>`).join("")}
  </div>`;

  // â”€â”€ CAPACITY TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const capacityTab=`
  <div class="card" style="padding:12px 18px;margin-bottom:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div>
        <div style="font-weight:700;font-size:15px;margin-bottom:2px">Live Seat Availability</div>
        <div style="font-size:12px;color:${C.mut}">Real-time Â· ${total} students allocated so far across all teachers</div>
      </div>
      <div style="display:flex;gap:10px">${chip("â–  Available",C.grn)}${chip("â–  Filling 75%+",C.amb)}${chip("â–  Full",C.red)}</div>
    </div>
  </div>
  ${["A","B","C"].map(sg2=>`
    <div style="margin-bottom:22px">
      <div style="font-size:11px;color:${C.mut};letter-spacing:2px;font-weight:700;margin-bottom:10px;border-bottom:1px solid ${C.bdr};padding-bottom:6px">
        SEGMENT ${sg2} â€” ${{"A":"NURSERY â€“ GRADE V","B":"GRADES VIâ€“VII","C":"VIIIâ€“IX"}[sg2]}
      </div>
      <div class="g4">
        ${CLUBS[sg2].map(cl=>{
          const n=cc[cl.id]||0,p=Math.round(n/cl.cap*100);
          const col=p>=100?C.red:p>=75?C.amb:C.grn;
          return `<div class="card" style="margin-bottom:0;padding:14px 16px;border-top:3px solid ${col}">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span style="font-weight:700;font-size:12px">${cl.id}: ${cl.name}</span>
              <span style="font-size:12px;font-weight:800;color:${col}">${n}/${cl.cap}</span>
            </div>
            ${capBar(n,cl.cap,"",false)}
            ${cl.acts?`<div style="margin-top:10px;border-top:1px solid ${C.bdr};padding-top:10px">
              <div style="font-size:10px;color:${C.mut};font-weight:700;letter-spacing:1px;margin-bottom:8px">ACTIVITIES</div>
              ${cl.acts.map(a=>capBar(ac[a.id]||0,a.cap,a.name,true)).join("")}
            </div>`:""}
          </div>`;
        }).join("")}
      </div>
    </div>
  `).join("")}`;

  // â”€â”€ GUIDE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const guideTab=`<div class="g3">
    ${[
      {n:"01",c:C.acc,t:"YOUR IDENTITY PANEL",pts:["Enter your name, grade and section ONCE at the top of the Entry tab","These stay locked for your full session â€” no need to re-enter","Only reset if you manually change them (e.g. switching to a different grade)","Student name and preferences reset after each entry automatically","A green confirmation line shows exactly which grade/section you are entering for"]},
      {n:"02",c:C.grn,t:"HOW TO ENTER STUDENTS",pts:["1. Complete your identity panel (name, grade, section)","2. Type student name","3. Select up to 3 club preferences â€” seats remaining shown live","4. For clubs with activities, select the specific activity","5. Press Enter or click '+ Add & Allocate'","6. A toast confirms the club allocated and which preference was used"]},
      {n:"03",c:C.amb,t:"PREFERENCE & FALLBACK",pts:["Always enter all 3 preferences even if clubs look full â€” seats can free up","If 1st preference is full â†’ 2nd is tried automatically","If 2nd is also full â†’ 3rd is tried automatically","If all 3 are full â†’ best available club is assigned (administrative)","Capacity warnings appear on the form in real time","Unallocated students are flagged for manual review"]},
      {n:"04",c:C.pur,t:"DUPLICATE PROTECTION",pts:["If you try to enter a student who is already in the databaseâ€¦","â€¦a red warning toast appears immediately","The entry is blocked â€” the student is NOT added again","Check the name spelling or contact admin if you believe it's a different student","This prevents accidental duplicate entries during busy sessions"]},
      {n:"05",c:C.teal,t:"YOUR ENTRIES TABLE",pts:["Below the form you can see ONLY the students YOU have entered","Other teachers' entries are not visible to you here","Capacity counts shown in dropdowns reflect ALL teachers' entries","This keeps your view clean while ensuring accurate seat counts","Admin can see all entries in the Results tab"]},
      {n:"06",c:C.red,t:"STATUS COLOUR GUIDE",pts:["ğŸŸ¢ GREEN = 1st preference honored","ğŸ”µ BLUE = 2nd preference used (1st was full)","ğŸŸ¡ AMBER = 3rd preference used","ğŸŸ£ PURPLE = administratively allocated (all 3 were full)","ğŸ”´ RED row = unallocated â€” needs admin manual review","Admin exports: Master Â· Club-wise Â· Grade-wise Â· Club+Grade-wise Â· Unallocated"]},
    ].map(card=>`<div class="card" style="border-left:3px solid ${card.c};padding:16px 18px">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
        <span style="font-size:20px;font-weight:900;color:${card.c}">${card.n}</span>
        <span style="font-weight:700;font-size:12px;letter-spacing:.4px">${card.t}</span>
      </div>
      ${card.pts.map(p=>`<div style="font-size:12px;color:${C.mut};margin-bottom:7px;padding-left:10px;border-left:2px solid ${C.bdr};line-height:1.6">${p}</div>`).join("")}
    </div>`).join("")}
  </div>`;

  const tabs={
    entry:entryTab,
    bulk:isAdmin?bulkTab:`<div class="card" style="text-align:center;padding:40px;color:${C.mut}">Admin access required</div>`,
    results:isAdmin?resultsTab:`<div class="card" style="text-align:center;padding:40px;color:${C.mut}">Admin access required</div>`,
    exports:isAdmin?exportsTab:`<div class="card" style="text-align:center;padding:40px;color:${C.mut}">Admin access required</div>`,
    capacity:capacityTab,
    guide:guideTab
  };

  return `${toastHTML}${hdr}<div style="max-width:1320px;margin:0 auto;padding:22px 18px">${tabs[tab]||""}</div>`;
}

// â”€â”€ GLOBAL FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Teacher identity â€” update silently while typing, re-render on blur
window.ST_by  = v => { teacher.by=v; };
window.ST_byR = v => { teacher.by=v; render(); };
window.ST_sec  = v => { teacher.sec=v; };
window.ST_secR = v => { teacher.sec=v; render(); };
window.ST_grade = v => {
  teacher.grade=v;
  // Reset preferences when grade changes (segment may change)
  form={name:form.name,p1:"",a1:"",p2:"",a2:"",p3:"",a3:""};
  render();
};

// Student form â€” name updates silently, re-renders on blur
window.SF  = (k,v) => { form[k]=v; };
window.SFR = (k,v) => { form[k]=v; render(); };
window.SP  = (pk,ak,v) => { form={...form,[pk]:v,[ak]:""}; render(); };

window.ST  = v => { tab=v; render(); };
window.AS  = addStudent;
window.DS  = delStudent;
window.CA  = clearAll;
window.IC  = importCSV;
window.EM  = exportMaster;
window.EC  = exportClubWise;
window.EG  = exportGradeWise;
window.ECG = exportClubGradeWise;
window.EU  = exportUnalloc;
window.DLT = ()=>dlCSV("Template_GDGoenka.csv",[
  `"Student Name","Grade","Section","Pref1","Pref1Activity","Pref2","Pref2Activity","Pref3","Pref3Activity","Teacher Name"`,
  `"Aarav Sharma","VI","A","B1","","B3","","B5","B5-Eco","Ms. Das"`,
  `"Priya Roy","VII","B","B7","B7-Western","B6","B6-Yoga","B2","B2-Debate","Mr. Sen"`
]);
window.render = render;

render();
</script>
</body>
</html>
